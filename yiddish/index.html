<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yiddish & Klezmer Calendar</title>

  <!-- ‚úÖ FullCalendar Global Bundle -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <link rel="stylesheet" href="index.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat+Brush&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"
          integrity="sha256-1/0GA1EkYejtvYFoa+rSq4LfM4m5zKI13Z1bQIhI4Co=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
          integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>
</head>
<body>


<img src="images/header.png" alt="" id="header-image">
<div id="left-side-flowers" class="side-flowers"></div>
<div id="right-side-flowers" class="side-flowers"></div>
<div id="calendar-container">
  <button class="signup-btn" onclick="alert('Signup form coming soon!')">‚úâÔ∏è Sign Up!</button>
  <div id="calendar"></div>
  <img src="images/bottom.png" alt="" id="bottom-image">
</div>

<div id="calendarModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div id="event-modal-content" class="modal-content"></div>
  </div>
</div>

<template id="event-modal-template">
  <div class="modal-header">
    <div><h5 id="modalTitle" class="modal-title">{{title}}</h5>
      <div class="date-time">{{date}} ‚Ä¢ {{time}}</div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div id="modalBody" class="modal-body">
    <div class="d-flex justify-content-end mb-3">
      {{#eventType}}<span class="badge bg-secondary ms-1">üé≠ {{eventType}}</span>{{/eventType}}
      {{#online}}<span class="badge bg-primary ms-1">üíª Online Event</span>{{/online}}
    </div>

    {{#location}}
      <div class="mb-2">
        {{#mapLink}}
        <a href="{{mapLink}}" target="_blank" class="text-decoration-none">
        {{/mapLink}}
        <span class="location">üìç {{location}}{{#address}}<br/>{{address}}{{/address}}</span>
        {{#mapLink}}
        </a>
        {{/mapLink}}
      </div>
    {{/location}}

    {{#description}}
      <div class="mb-4"><span>{{description}}</span></div>
    {{/description}}
    {{#event_website}}
      <div class="mb-2"><a href="{{event_website}}" target="_blank" class="btn btn-outline-primary btn-sm">üåê Event
        Website</a></div>
    {{/event_website}}

  </div>

</template>

<div id="debug-box">
  <strong>Debug</strong><br>
  <label><input type="checkbox" id="testData"> <a href="https://docs.google.com/spreadsheets/d/18uQTvIdS0VDxrJfadJIgpAatkoDRcs53_ZYdjzWRuBA/edit?gid=0#gid=0" target="_blank">Akiva's extra test data</a></label><br>
  <label><input type="checkbox" id="publishedOnly"> Published events only</label>
</div>

<script>
  let calendar;
  document.addEventListener('DOMContentLoaded', function () {
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      themeSystem: 'bootstrap5',
      height: 'auto',
      events: getEvents, // function to fetch events from Google Sheets
      eventClick: openEventModal,
      customButtons: {
        prevHand: {
          text: '<<', click() {
            calendar.prev();
          }
        },
        nextHand: {
          text: '>>', click() {
            calendar.next();
          }
        }
        ,
      },
    });

    calendar.render();

    function updateCalendarView() {
      if (window.innerWidth < 992) {
        calendar.changeView('listMonth');
        calendar.setOption('headerToolbar', {start: '', center: 'title', end: 'prevHand nextHand'});
      } else {
        calendar.setOption('headerToolbar', {start: 'prevHand', center: 'title', end: 'nextHand'});
        calendar.changeView('dayGridMonth');
      }
    }

    updateCalendarView();
    window.addEventListener('resize', updateCalendarView);
  })

  const openEventModal = function (info) {
    const event = info.event;
    const props = event.extendedProps;

    // Prepare data for template
    const data = {
      title: event.title,
      date: event.start.toLocaleDateString(),
      time: event.allDay ? 'All day' :
        event.start && event.end ?
          `${event.start.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
          })} - ${event.end.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}` :
          event.start ? event.start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '',
      location: props.location,
      address: props.address,
      online: props.online,
      eventType: props.eventType,
      description: props.description,
      event_website: props.event_website,
      mapLink: props.mapLink
    };

    // Render template
    const template = document.getElementById('event-modal-template').innerHTML;
    document.getElementById('event-modal-content').innerHTML = Mustache.render(template, data);

    const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
    modal.show();
  };

  // Pull event data from Google Sheets CSV export
  let useTestData = document.getElementById('testData').checked;
  let publishedOnly = document.getElementById('publishedOnly').checked;
  document.getElementById('testData').addEventListener('change', function (e) {
    useTestData = e.target.checked;
    calendar.refetchEvents();
  });
  document.getElementById('publishedOnly').addEventListener('change', function (e) {
    publishedOnly = e.target.checked;
    calendar.refetchEvents();
  });

  // Update getEvents to use these flags
  function getEvents(info, successCallback, failureCallback) {
    const realSheet = "https://docs.google.com/spreadsheets/d/12t8KGJtAxdoStRRCUGXPvZDbJGuxJ9j1j02irCR5isI";
    const testSheet = "https://docs.google.com/spreadsheets/d/18uQTvIdS0VDxrJfadJIgpAatkoDRcs53_ZYdjzWRuBA";
    const link = useTestData ? testSheet : realSheet;
    fetch(`${link}/export?format=csv`)
      .then(response => response.text())
      .then(csv => {
        if (!csv) {
          failureCallback("No data");
        }
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            let events = results.data.map(ev => mapRowToEvent(ev));
            if (publishedOnly) {
              events = events.filter(ev => ev.extendedProps.published);
            }
            successCallback(events);
          }
        });
      });
  }

  // data is in the format
  dataFormat = [
    "Published?",
    "Title",
    "Short title (for print)",
    "Date",
    "Start time",
    "End time",
    "Event website",
    "Location name",
    "Map link",
    "Location address",
    "Online?",
    "Event type",
    "General link (performer, series, etc.)",
    "Description"
  ]


  function toISO8601(dateStr, timeStr = "") {

    if (!dateStr) return null;
    // If no time, treat as all-day
    if (!timeStr) return new Date(dateStr).toISOString().split('T')[0];

    // Expect MM/DD/YYYY
    const [month, day, year] = dateStr.split('/');

    // Build a normalized string: "YYYY-MM-DD h:mm AM/PM"
    const normalized = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}` +
      (timeStr ? ` ${timeStr}` : "");

    const date = new Date(normalized);
    if (isNaN(date)) return null;

    if (!timeStr) return date.toISOString().slice(0, 10);
    return date.toISOString();
  }

  // Map a row to FullCalendar event object
  function mapRowToEvent(row) {
    const start = toISO8601(row['Date'], row['Start time']);
    const end = toISO8601(row['Date'], row['End time']);
    return {
      title: row['Title'] || '',
      start,
      end: end || undefined,
      allDay: !row['Start time'],
      extendedProps: {
        event_website: row['Event website'] || undefined,
        location: row['Location name'] || '',
        address: row['Location address'] || '',
        online: row['Online?'] === 'TRUE',
        eventType: row['Event type'] || '',
        description: row['Description'] || '',
        mapLink: row['Map link'] || '',
        shortTitle: row['Short title (for print)'] || '',
        generalLink: row['General link (performer, series, etc.)'] || '',
        published: row['Published?'] === 'TRUE'
      }
    };
  };
</script>

</body>
</html>
